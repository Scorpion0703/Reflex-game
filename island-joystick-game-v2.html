<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Island Game Test • v2 (no-scroll)</title>
<style>
  html,body{
    margin:0; padding:0; height:100%;
    background:#89c78a; font-family:sans-serif;
    overflow:hidden;                 /* kein Scrollbalken */
    touch-action:none;               /* verhindert Browser-Gesten */
    overscroll-behavior:none;        /* kein Gummi-Scroll */
  }
  canvas{ display:block; width:100%; height:100%; }
  /* Virtual Joystick */
  #joystick,#stick{ position:fixed; border-radius:50%; z-index:10; }
  #joystick{
    bottom:30px; left:30px; width:140px; height:140px;
    background:rgba(255,255,255,.18); backdrop-filter:blur(8px);
    border:2px solid rgba(255,255,255,.35);
    touch-action:none;               /* wichtig auf iOS */
  }
  #stick{
    width:50px; height:50px; left:45px; top:calc(100% - 95px);
    background:#fff; border:0; transform:translateY(-50%);
    pointer-events:none;
  }
</style>
</head>
<body>

<div id="joystick" aria-label="Joystick" role="application"></div>
<div id="stick"></div>

<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script>
/* ==== THREE setup ==== */
const scene = new THREE.Scene(); scene.background = new THREE.Color(0x88cc88);
const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0,5,8);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);

const light = new THREE.DirectionalLight(0xffffff,1); light.position.set(5,10,5); scene.add(light);
const ground = new THREE.Mesh(new THREE.PlaneGeometry(100,100), new THREE.MeshPhongMaterial({color:0x7cb66d}));
ground.rotation.x = -Math.PI/2; scene.add(ground);
const player = new THREE.Mesh(new THREE.BoxGeometry(1,1.5,1), new THREE.MeshPhongMaterial({color:0xff6666}));
player.position.y = 0.75; scene.add(player);

addEventListener('resize', ()=>{
  renderer.setSize(innerWidth,innerHeight);
  camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix();
});

/* ==== Joystick (no-scroll) ==== */
const joy = document.getElementById('joystick');
const stick = document.getElementById('stick');
const JOY_R = 70;          // Radius des äußeren Kreises (px)
const KNOB_R = 40;         // Weg des Sticks (px)
let joyOn=false, joyCX=0, joyCY=0, joyX=0, joyY=0;

function centerStick(cx,cy){ stick.style.left = (cx - KNOB_R + (JOY_R-KNOB_R)) + 'px';
  stick.style.top = (cy - KNOB_R) + 'px'; }
function setStick(cx,cy,x,y){
  const dx=x-cx, dy=y-cy, dist=Math.hypot(dx,dy), ang=Math.atan2(dy,dx), r=Math.min(KNOB_R, dist);
  stick.style.left = (cx + Math.cos(ang)*r - KNOB_R) + 'px';
  stick.style.top  = (cy + Math.sin(ang)*r - KNOB_R) + 'px';
  joyX = dist<6 ? 0 : dx/KNOB_R;
  joyY = dist<6 ? 0 : dy/KNOB_R;
}

joy.addEventListener('touchstart', (e)=>{
  const t=e.changedTouches[0];
  const rect = joy.getBoundingClientRect();
  joyOn=true;
  joyCX = rect.left + JOY_R;
  joyCY = rect.top  + JOY_R;
  centerStick(joyCX,joyCY);
  setStick(joyCX,joyCY,t.clientX,t.clientY);
  e.preventDefault();                 // <<< blockt Scroll
}, {passive:false});

joy.addEventListener('touchmove', (e)=>{
  if(!joyOn) return;
  const t=e.changedTouches[0];
  setStick(joyCX,joyCY,t.clientX,t.clientY);
  e.preventDefault();                 // <<< blockt Scroll
}, {passive:false});

joy.addEventListener('touchend', (e)=>{
  joyOn=false; joyX=0; joyY=0;
  centerStick(joyCX,joyCY);
  e.preventDefault();                 // <<< blockt Scroll
}, {passive:false});
joy.addEventListener('touchcancel', (e)=>{ joyOn=false; joyX=joyY=0; centerStick(joyCX,joyCY); e.preventDefault(); }, {passive:false});

/* Fallback: Tastatur */
const keys={}; addEventListener('keydown',e=>keys[e.code]=true); addEventListener('keyup',e=>keys[e.code]=false);

/* ==== Game loop ==== */
function step(dt){
  // Keyboard fallback
  let kx=(keys['KeyD']||keys['ArrowRight']?1:0)-(keys['KeyA']||keys['ArrowLeft']?1:0);
  let ky=(keys['KeyS']||keys['ArrowDown']?1:0)-(keys['KeyW']||keys['ArrowUp']?1:0);

  // Joystick hat Vorrang, wenn aktiv
  if(joyOn){ kx = joyX; ky = joyY; }

  player.position.x += kx * 4 * dt;
  player.position.z += ky * 4 * dt;

  // Kamera folgt weich
  camera.position.x += ((player.position.x + 5) - camera.position.x) * 0.08;
  camera.position.z += ((player.position.z + 8) - camera.position.z) * 0.08;
  camera.lookAt(player.position);
}

let last = performance.now();
(function loop(t){
  const dt = Math.min(0.033, (t-last)/1000); last=t;
  step(dt); renderer.render(scene,camera); requestAnimationFrame(loop);
})(last);
</script>
</body>
</html>
