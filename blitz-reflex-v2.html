<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Blitz-Reflex V2 • Sounds + Partikel + Settings</title>
<style>
  :root {
    --bg:#0f1220; --panel:#151a2f; --accent:#6ee7ff; --muted:#9aa4b2; --ok:#2ecc71; --warn:#ffb020; --bad:#ff5c5c;
  }
  * {box-sizing:border-box}
  html,body {height:100%}
  body {
    margin:0; font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background: radial-gradient(1200px 700px at 70% -10%, #1a1f3d 0%, var(--bg) 60%);
    color:#e8eef7; display:flex; align-items:center; justify-content:center; padding:24px;
  }
  .card {
    width:min(980px,100%); background:linear-gradient(180deg,#171c34 0%, var(--panel) 100%);
    border:1px solid #1f2747; border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.45);
    padding:22px; display:grid; gap:16px; grid-template-columns:340px 1fr; align-items:start;
  }
  h1 {margin:0 0 6px; font-size:28px; letter-spacing:.3px}
  .sub {color:var(--muted); margin-top:-4px}
  .controls {display:grid; gap:10px}
  label {display:block; margin-bottom:6px; color:var(--muted); font-size:14px}
  .row {display:flex; gap:10px; flex-wrap:wrap}
  select,button,input[type="range"]{
    appearance:none; border:1px solid #273157; background:#0f1430; color:#e8eef7;
    padding:10px 12px; border-radius:12px; font-weight:600; letter-spacing:.2px;
  }
  button.primary {background:linear-gradient(180deg,#1d2a67,#122055); border-color:#2c3c7c}
  button.primary:disabled {opacity:.6; cursor:not-allowed}
  .stats {display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:6px;}
  .stat {background:#0f1430; border:1px solid #1f2747; padding:10px 12px; border-radius:12px}
  .stat b {display:block; font-size:18px; margin-bottom:2px}
  .arena {
    grid-column: 1 / -1; display:grid; place-items:center; background:#0e1227;
    border:1px dashed #26305a; border-radius:16px; padding:20px; min-height:380px; position:relative; overflow:hidden;
  }
  .circle {
    width:min(260px,40vmin); aspect-ratio:1; border-radius:50%;
    display:grid; place-items:center; font-weight:800; font-size:clamp(18px,3.3vmin,24px);
    user-select:none; cursor:pointer; transition:transform .12s ease;
    box-shadow: inset 0 0 40px rgba(255,255,255,.05), 0 14px 36px rgba(0,0,0,.35);
    z-index:2;
  }
  .circle:active { transform: scale(.98) }
  .hint {position:absolute; bottom:16px; color:var(--muted); font-size:14px; text-align:center; z-index:2}
  .pill {display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid #2a3565; margin-left:8px; color:#b8c3d6}
  #log {background: rgba(0,0,0,0.25); border:1px solid rgba(255,255,255,0.08); padding:12px; border-radius:10px;
        height:180px; overflow:auto; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:13px;
        color:#d1d9e6; backdrop-filter: blur(8px); box-shadow: inset 0 0 10px rgba(0,0,0,0.2);}
  .log-entry{display:flex;align-items:center;gap:8px;padding:4px 0;opacity:0;animation:fadeIn .25s forwards}
  .log-entry .dot{width:8px;height:8px;border-radius:50%;background:#4dd2a7;box-shadow:0 0 8px #4dd2a7}
  .log-entry.fail .dot{background:#ff6b6b; box-shadow:0 0 8px #ff6b6b}
  .log-entry.fake .dot{background:#ffb020; box-shadow:0 0 8px #ffb020}
  .log-entry .time{color:#8ab4ff}
  @keyframes fadeIn {to{opacity:1}}
  /* Settings */
  .settings-btn{margin-left:8px; border-radius:12px; display:inline-flex; align-items:center; gap:8px}
  dialog.settings{
    border:1px solid #2a3565; background:#0f1430; color:#e8eef7; border-radius:16px; padding:16px 16px 8px; width:min(520px,92vw)
  }
  .settings h3{margin:0 0 8px}
  .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .rowline{display:flex; align-items:center; justify-content:space-between; gap:10px; background:#0b112b; border:1px solid #1f2747; padding:10px 12px; border-radius:12px}
  .range{flex:1}
  .closex{float:right; background:#1b285d; border:1px solid #2c3c7c}
  canvas#fx{position:absolute; inset:0; z-index:1; pointer-events:none}
</style>
</head>
<body>
  <div class="card">
    <div>
      <h1>Blitz-Reflex <small class="pill">V2</small></h1>
      <div class="sub">
        Warte auf <b style="color:var(--ok)">Grün</b> und reagiere. 
        <span id="bestPill" class="pill" title="Deine beste Reaktionszeit">Best: –</span>
        <button id="openSettings" class="settings-btn">⚙️ Einstellungen</button>
      </div>

      <div class="controls">
        <div class="row">
          <div style="flex:1">
            <label for="mode">Modus</label>
            <select id="mode">
              <option value="solo">Single-Player</option>
              <option value="duo">2-Player (A vs. L)</option>
            </select>
          </div>
          <div>
            <label for="rounds">Runden</label>
            <select id="rounds">
              <option>5</option><option selected>10</option><option>20</option>
            </select>
          </div>
          <div>
            <label for="fakeouts">Täuschungen</label>
            <select id="fakeouts">
              <option value="off">Aus</option>
              <option value="on" selected>An</option>
            </select>
          </div>
        </div>
        <div class="row">
          <button id="startBtn" class="primary">Start</button>
          <button id="resetBtn">Reset</button>
        </div>
        <div class="stats">
          <div class="stat"><b id="statRound">–/–</b><span>Runde</span></div>
          <div class="stat"><b id="statAvg">–</b><span>Ø Reaktion</span></div>
          <div class="stat"><b id="statScore">0</b><span>Score (Duo)</span></div>
        </div>
      </div>

      <div class="stat" style="margin-top:10px">
        <b>Log</b>
        <div id="log" aria-live="polite"></div>
      </div>
    </div>

    <div class="arena" id="arena">
      <canvas id="fx"></canvas>
      <div id="circle" class="circle" role="button" aria-label="Spielfeld"></div>
      <div class="hint" id="hint"></div>
    </div>
  </div>

  <!-- Einstellungen -->
  <dialog id="settingsDlg" class="settings">
    <button class="closex" id="closeSettings">Schließen ✖</button>
    <h3>⚙️ Einstellungen</h3>
    <div class="grid-2">
      <div class="rowline">
        <span>Sounds</span>
        <label><input type="checkbox" id="optSound" checked /> an</label>
      </div>
      <div class="rowline">
        <span>Lautstärke</span>
        <input type="range" id="optVolume" class="range" min="0" max="100" value="60">
      </div>
      <div class="rowline">
        <span>Partikel</span>
        <label><input type="checkbox" id="optParticles" checked /> an</label>
      </div>
      <div class="rowline">
        <span>Partikel-Dichte</span>
        <input type="range" id="optDensity" class="range" min="10" max="120" value="50">
      </div>
      <div class="rowline">
        <span>Täuschungsrate</span>
        <input type="range" id="optFakeRate" class="range" min="0" max="60" value="28">
      </div>
    </div>
  </dialog>

<script>
(() => {
  const circle = document.getElementById('circle');
  const hint = document.getElementById('hint');
  const logEl = document.getElementById('log');
  const modeSel = document.getElementById('mode');
  const roundsSel = document.getElementById('rounds');
  const fakeSel = document.getElementById('fakeouts');
  const startBtn = document.getElementById('startBtn');
  const resetBtn = document.getElementById('resetBtn');
  const statRound = document.getElementById('statRound');
  const statAvg = document.getElementById('statAvg');
  const statScore = document.getElementById('statScore');
  const bestPill = document.getElementById('bestPill');
  const fxCanvas = document.getElementById('fx');
  const openSettings = document.getElementById('openSettings');
  const settingsDlg = document.getElementById('settingsDlg');
  const closeSettings = document.getElementById('closeSettings');
  const optSound = document.getElementById('optSound');
  const optVolume = document.getElementById('optVolume');
  const optParticles = document.getElementById('optParticles');
  const optDensity = document.getElementById('optDensity');
  const optFakeRate = document.getElementById('optFakeRate');

  const Colors = {
    wait: '#39446f',
    ready: '#2ecc71',
    tooSoon: '#ff5c5c',
    fake: '#ffb020',
  };

  let state = {
    started:false, awaiting:false, ready:false, isFake:false,
    tStart:0, round:0, rounds:10, mode:'solo', allowFakes:true,
    results:[], scoreLeft:0, scoreRight:0,
    sound:true, volume:0.6, particles:true, density:50, fakeRate:0.28
  };

  // load user prefs
  try{
    const prefs = JSON.parse(localStorage.getItem('br_prefs')||'{}');
    Object.assign(state, prefs);
  }catch{}

  // apply UI from state
  optSound.checked = state.sound;
  optVolume.value = Math.round(state.volume*100);
  optParticles.checked = state.particles;
  optDensity.value = state.density;
  optFakeRate.value = Math.round(state.fakeRate*100);

  const fmt = ms => `${ms.toFixed(0)} ms`;
  const avg = arr => arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length) : 0;

  function savePrefs(){
    localStorage.setItem('br_prefs', JSON.stringify({
      sound:state.sound, volume:state.volume, particles:state.particles,
      density:state.density, fakeRate:state.fakeRate
    }));
  }

  function setCircle(color, text){
    circle.style.background = color; circle.textContent = text || '';
  }
  function setHint(text){ hint.textContent = text || ''; }

  function addLog(message, cls=''){
    const t = new Date().toLocaleTimeString();
    const row = document.createElement('div');
    row.className = `log-entry ${cls}`;
    row.innerHTML = `<span class="dot"></span><span class="time">[${t}]</span><span>${message}</span>`;
    logEl.appendChild(row);
    logEl.scrollTop = logEl.scrollHeight;
  }
  function loadBest() {
    const v = localStorage.getItem('br_best_ms');
    bestPill.textContent = `Best: ${v ? fmt(Number(v)) : '–'}`;
  }
  function saveBest(ms){
    const v = localStorage.getItem('br_best_ms');
    if(!v || ms < Number(v)){ localStorage.setItem('br_best_ms', String(ms)); loadBest(); }
  }
  function updateStats(){
    statRound.textContent = `${Math.min(state.round, state.rounds)}/${state.rounds}`;
    const a = avg(state.results);
    statAvg.textContent = state.results.length ? fmt(a) : '–';
    statScore.textContent = `${state.scoreLeft} : ${state.scoreRight}`;
  }

  function reset(all=false){
    state.started=false; state.awaiting=false; state.ready=false; state.isFake=false;
    state.tStart=0; state.round=0; state.results=[]; state.scoreLeft=0; state.scoreRight=0;
    setCircle(Colors.wait, 'Bereit?');
    setHint('Wähle einen Modus und drücke Start.');
    if(all) logEl.innerHTML='';
    updateStats();
  }

  function nextRound(){
    if(state.round >= state.rounds){ finish(); return; }
    state.round++; updateStats();
    state.ready=false; state.awaiting=true; state.isFake=false;
    setCircle(Colors.wait, 'Warten…');
    const delay = 900 + Math.random()*1700;
    const willFake = state.allowFakes && Math.random() < state.fakeRate;
    const fakeDelay = 250 + Math.random()*350;
    setHint(state.mode==='solo' ? 'Klicke erst bei GRÜN!' : 'Drücke A (links) oder L (rechts) bei GRÜN.');

    setTimeout(() => {
      if(!state.awaiting) return;
      if(willFake){
        state.isFake = true;
        setCircle(Colors.fake, 'Täuschung!');
        sfx('fake');
        burst('fake');
        setTimeout(() => {
          if(!state.awaiting) return;
          setCircle(Colors.wait, 'Warten…');
          setTimeout(armReady, 500 + Math.random()*900);
        }, fakeDelay);
      } else {
        armReady();
      }
    }, delay);
  }

  function armReady(){
    state.ready = true; state.awaiting = true; state.isFake=false;
    state.tStart = performance.now();
    setCircle(Colors.ready, 'JETZT!');
    sfx('ready');
    pulse(circle);
  }

  function finish(){
    state.started=false; state.awaiting=false; state.ready=false;
    setCircle(Colors.wait, 'Fertig');
    const a = avg(state.results);
    if(state.mode==='solo'){
      if(state.results.length){
        addLog(`Runden beendet • Ø ${fmt(a)} • Best ${fmt(Math.min(...state.results))}`);
      } else addLog('Keine gültige Messung.');
    } else {
      const winner = state.scoreLeft===state.scoreRight ? 'Unentschieden' :
        (state.scoreLeft>state.scoreRight ? 'Links gewinnt!' : 'Rechts gewinnt!');
      addLog(`Match Ende • Score ${state.scoreLeft}:${state.scoreRight} • ${winner}`);
    }
    setHint('Nochmal? Passe die Einstellungen an und drücke Start.');
  }

  /* ---------- SFX (WebAudio) ---------- */
  let audioCtx = null;
  function sfx(type){
    if(!state.sound) return;
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const t0 = audioCtx.currentTime;
      const g = audioCtx.createGain(); g.gain.value = 0.0001;
      const o = audioCtx.createOscillator();
      o.type = 'square';
      o.connect(g); g.connect(audioCtx.destination);

      const vol = state.volume; // 0..1

      function env(start=0.0001, peak=0.12, decay=0.08){
        g.gain.setValueAtTime(start, t0);
        g.gain.exponentialRampToValueAtTime(peak*vol, t0+0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, t0+0.02+decay);
      }

      if(type==='ready'){ o.frequency.setValueAtTime(880,t0); env(0.0001,0.10,0.12); }
      if(type==='hit'){  o.frequency.setValueAtTime(560,t0); o.frequency.exponentialRampToValueAtTime(1200,t0+0.12); env(0.0001,0.16,0.18); }
      if(type==='fail'){ o.frequency.setValueAtTime(220,t0); o.frequency.exponentialRampToValueAtTime(110,t0+0.18); env(0.0001,0.2,0.25); }
      if(type==='fake'){ o.frequency.setValueAtTime(320,t0); env(0.0001,0.08,0.06); }
      if(type==='start'){o.frequency.setValueAtTime(440,t0); env(0.0001,0.12,0.12); }

      o.start(); o.stop(t0+0.35);
    }catch{}
  }

  /* ---------- Particles (Canvas) ---------- */
  const fx = fxCanvas.getContext('2d');
  function resizeFx(){
    fxCanvas.width = fxCanvas.clientWidth;
    fxCanvas.height = fxCanvas.clientHeight;
  }
  new ResizeObserver(resizeFx).observe(fxCanvas); resizeFx();

  const particles = [];
  function burst(kind='hit', x=null, y=null){
    if(!state.particles) return;
    const rect = circle.getBoundingClientRect();
    const arenaRect = fxCanvas.getBoundingClientRect();
    const cx = x ?? (rect.left + rect.width/2);
    const cy = y ?? (rect.top + rect.height/2);
    const ox = cx - arenaRect.left;
    const oy = cy - arenaRect.top;

    const n = Math.round(state.density/5);
    const color = kind==='hit'? Colors.ready : (kind==='fail'? Colors.tooSoon : Colors.fake);
    for(let i=0;i<n;i++){
      const a = Math.random()*Math.PI*2;
      const sp = 1+Math.random()*3;
      particles.push({
        x:ox,y:oy,vx:Math.cos(a)*sp, vy:Math.sin(a)*sp,
        life:0.8+Math.random()*0.6, r:2+Math.random()*2, c:color
      });
    }
  }
  function pulse(el){
    el.animate([{transform:'scale(1)'},{transform:'scale(1.06)'},{transform:'scale(1)'}],
      {duration:220, easing:'ease'});
  }
  function tick(dt){
    fx.clearRect(0,0,fxCanvas.width,fxCanvas.height);
    for(let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.life -= dt; if(p.life<=0){ particles.splice(i,1); continue; }
      p.x += p.vx; p.y += p.vy; p.vy += 0.02; // gravity
      fx.globalAlpha = Math.max(p.life,0);
      fx.beginPath(); fx.arc(p.x,p.y,p.r,0,Math.PI*2);
      fx.fillStyle = p.c; fx.fill();
    }
    requestAnimationFrame(loop);
  }
  let last=performance.now();
  function loop(ts){ const dt=(ts-last)/1000; last=ts; tick(dt); }
  requestAnimationFrame(loop);

  /* ---------- Game input ---------- */
  function onAction(side, evt){ // side: 'solo' | 'L' | 'R'
    if(!state.started) return;

    if(state.awaiting && !state.ready || state.isFake){
      setCircle(Colors.tooSoon, 'Zu früh!');
      sfx('fail'); burst('fail', evt?.clientX, evt?.clientY);
      if(state.mode==='duo'){
        if(side==='L') state.scoreRight++; else if(side==='R') state.scoreLeft++;
        addLog(`${side==='L'?'Links':'Rechts'} Fehlstart • Punkt für ${side==='L'?'Rechts':'Links'}`,'fail');
      } else addLog('Fehlstart – warte auf Grün.','fail');
      state.awaiting=false; updateStats(); setTimeout(nextRound, 700); return;
    }

    if(state.ready){
      const t = performance.now() - state.tStart;
      setCircle(Colors.wait, fmt(t));
      sfx('hit'); burst('hit', evt?.clientX, evt?.clientY);
      if(state.mode==='duo'){
        if(state.awaiting){
          if(side==='L') state.scoreLeft++; else if(side==='R') state.scoreRight++;
          addLog(`${side==='L'?'Links':'Rechts'} gewinnt die Runde • ${fmt(t)}`);
          state.awaiting=false; updateStats(); setTimeout(nextRound, 700);
        }
      } else {
        state.results.push(t); saveBest(t); addLog(`Reaktion: ${fmt(t)}`); updateStats(); setTimeout(nextRound, 700);
      }
      return;
    }
  }

  circle.addEventListener('click', (e)=>{ if(state.mode==='solo') onAction('solo',e); });
  document.addEventListener('keydown', (e) => {
    if(state.mode!=='duo' || e.repeat) return;
    if(e.key.toLowerCase()==='a') onAction('L');
    if(e.key.toLowerCase()==='l') onAction('R');
  });

  startBtn.addEventListener('click', () => {
    state.mode = modeSel.value;
    state.rounds = Number(roundsSel.value);
    state.allowFakes = fakeSel.value === 'on';
    state.fakeRate = Number(optFakeRate.value)/100;
    state.started=true; state.results=[]; state.scoreLeft=0; state.scoreRight=0; state.round=0;
    addLog(`Start • Modus: ${state.mode==='solo'?'Single-Player':'2-Player'} • Runden: ${state.rounds} • Täuschungen: ${state.allowFakes?'An':'Aus'}`);
    updateStats(); sfx('start'); nextRound();
  });
  resetBtn.addEventListener('click', () => reset(true));
  modeSel.addEventListener('change', () => setHint(modeSel.value==='solo'
    ? 'Klicke erst bei GRÜN!' : 'Drücke A (links) oder L (rechts) bei GRÜN.'));

  // settings
  openSettings.addEventListener('click', ()=> settingsDlg.showModal());
  closeSettings.addEventListener('click', ()=> settingsDlg.close());
  optSound.addEventListener('change', ()=>{ state.sound = optSound.checked; savePrefs(); });
  optVolume.addEventListener('input', ()=>{ state.volume = Number(optVolume.value)/100; savePrefs(); });
  optParticles.addEventListener('change', ()=>{ state.particles = optParticles.checked; savePrefs(); });
  optDensity.addEventListener('input', ()=>{ state.density = Number(optDensity.value); savePrefs(); });
  optFakeRate.addEventListener('input', ()=>{ state.fakeRate = Number(optFakeRate.value)/100; savePrefs(); });

  // Init
  loadBest(); reset(false);
})();
</script>
</body>
</html>
