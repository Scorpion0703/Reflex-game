<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Orb Walk 3D â€¢ Joystick</title>
<style>
  html,body{height:100%;margin:0;background:#05070f;color:#cfe3ff;font-family:system-ui}
  #hud{position:fixed;left:10px;top:10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);
       padding:8px 10px;border-radius:10px;backdrop-filter:blur(8px);font-size:14px;z-index:20}
  canvas{display:block;width:100%;height:100%}

  /* Virtual Joystick (floating) */
  #joyBase,#joyKnob{position:fixed;border-radius:50%;pointer-events:none;z-index:15;opacity:0;transition:opacity .1s}
  #joyBase{width:160px;height:160px;border:2px solid rgba(124,248,255,.45);background:rgba(124,248,255,.08);transform:translate(-50%,-50%)}
  #joyKnob{width:90px;height:90px;border:2px solid rgba(124,248,255,.9);background:rgba(124,248,255,.25);backdrop-filter:blur(6px);transform:translate(-50%,-50%)}

  /* Jump button (mobile) */
  #jump{position:fixed;right:18px;bottom:18px;width:74px;height:74px;border-radius:50%;
        display:grid;place-items:center;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);
        color:#eaf2ff;font-weight:800;user-select:none;z-index:16}
  @media (pointer:fine){ #jump{display:none} } /* nur auf Touch anzeigen */
</style>

<div id="hud">Links tippen & ziehen = Joystick â€¢ Rechts wischen = Kamera â€¢ ðŸŸ¡ Ringe einsammeln â€¢ Space/Jump</div>
<canvas id="c"></canvas>
<div id="joyBase"></div><div id="joyKnob"></div>
<div id="jump">â¤´ï¸Ž</div>

<script type="module">
import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
import {OrbitControls} from "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js";

/* ---------- Renderer / Scene ---------- */
const canvas = document.getElementById('c');
const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.setSize(innerWidth, innerHeight);
renderer.outputColorSpace = THREE.SRGBColorSpace;

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x05070f);

/* Lights */
scene.add(new THREE.HemisphereLight(0x88ccff, 0x223344, 1.1));
const dir = new THREE.DirectionalLight(0xffffff, 0.8);
dir.position.set(5,8,3);
scene.add(dir);

/* Camera + Controls */
const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 300);
camera.position.set(0,6,14);
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.target.set(0,1,0);
controls.enablePan = true;
controls.maxPolarAngle = Math.PI*0.49;
// Touch-Config: 1 Finger rechts = ROTATE, 2 Finger = DOLLY+PAN
controls.touches = { ONE: THREE.TOUCH.ROTATE, TWO: THREE.TOUCH.DOLLY_PAN };

/* World */
const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(240,240, 40,40),
  new THREE.MeshStandardMaterial({color:0x0b1436, metalness:0.2, roughness:0.9})
);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

/* Player */
const pMat = new THREE.MeshStandardMaterial({color:0x7cf8ff, metalness:0.2, roughness:0.3, emissive:0x115577, emissiveIntensity:0.35});
const player = new THREE.Mesh(new THREE.SphereGeometry(1,32,32), pMat);
player.position.set(0,1,0);
scene.add(player);

/* Coins */
const coinGeo = new THREE.TorusGeometry(0.6,0.2,16,32);
const coinMat = new THREE.MeshStandardMaterial({color:0xffd250, emissive:0x7a4a00, emissiveIntensity:0.6});
const coins = [...Array(24)].map(()=>{
  const m = new THREE.Mesh(coinGeo, coinMat);
  m.position.set((Math.random()*2-1)*100, 1, (Math.random()*2-1)*100);
  scene.add(m);
  return m;
});

/* ---------- Input: Keyboard + Virtual Joystick ---------- */
const keys = {};
addEventListener('keydown', e=>keys[e.code]=true);
addEventListener('keyup',   e=>keys[e.code]=false);

/* Floating Joystick */
const JOY_MAX = 70;  // px Radius (CSS-Pixel)
const joyBase = document.getElementById('joyBase');
const joyKnob = document.getElementById('joyKnob');
let joyActive=false, joyId=null, joyCX=0, joyCY=0;
let jx=0, jy=0; // -1..1

function showJoy(x,y){ joyBase.style.left=x+'px'; joyBase.style.top=y+'px'; joyKnob.style.left=x+'px'; joyKnob.style.top=y+'px';
  joyBase.style.opacity=1; joyKnob.style.opacity=1; }
function hideJoy(){ joyBase.style.opacity=0; joyKnob.style.opacity=0; }
function setJoyVector(cx,cy,x,y){
  const dx=x-cx, dy=y-cy, dist=Math.hypot(dx,dy), ang=Math.atan2(dy,dx), r=Math.min(JOY_MAX, dist);
  joyKnob.style.left=(cx+Math.cos(ang)*r)+'px';
  joyKnob.style.top =(cy+Math.sin(ang)*r)+'px';
  jx = (dist<8)?0:dx/JOY_MAX;          // -1..1 (rechts positiv)
  jy = (dist<8)?0:dy/JOY_MAX;          // -1..1 (unten positiv)
}

/* Touch areas:
   - Linke 60% Bildschirmbreite => Joystick (bewegt)
   - Rechte 40% => Kamera (OrbitControls standard) */
addEventListener('touchstart', (e)=>{
  for(const t of e.changedTouches){
    if(joyActive) continue;
    if(t.clientX > innerWidth*0.6) continue; // rechts fÃ¼r Kamera lassen
    joyActive=true; joyId=t.identifier; joyCX=t.clientX; joyCY=t.clientY;
    showJoy(joyCX, joyCY);
    setJoyVector(joyCX, joyCY, t.clientX, t.clientY);
    e.preventDefault(); // verhindert Scroll/Zoom
  }
},{passive:false});

addEventListener('touchmove', (e)=>{
  if(!joyActive) return;
  for(const t of e.changedTouches){
    if(t.identifier===joyId){
      setJoyVector(joyCX, joyCY, t.clientX, t.clientY);
      e.preventDefault();
    }
  }
},{passive:false});

function endJoyById(id){
  if(joyId!==id) return false;
  joyActive=false; joyId=null; jx=0; jy=0; hideJoy(); return true;
}
addEventListener('touchend',   e=>{ for(const t of e.changedTouches){ if(endJoyById(t.identifier)) e.preventDefault(); } }, {passive:false});
addEventListener('touchcancel',e=>{ for(const t of e.changedTouches){ if(endJoyById(t.identifier)) e.preventDefault(); } }, {passive:false});

/* Jump button */
const jumpBtn = document.getElementById('jump');
let wantJump=false;
jumpBtn.addEventListener('touchstart', e=>{ wantJump=true; }, {passive:true});
jumpBtn.addEventListener('touchend',   e=>{ /* noop */ }, {passive:true});

/* ---------- Movement / Physics ---------- */
let vy=0;
const SPEED = 12;     // ground speed
const GRAV  = 30;     // gravity
const JUMP  = 12;

function moveVectorFromInput(){
  // Kamera-Orientierung -> vorwÃ¤rtsrichtung (XZ)
  const forward = new THREE.Vector3();
  camera.getWorldDirection(forward);
  forward.y = 0; forward.normalize();
  const right = new THREE.Vector3().crossVectors(new THREE.Vector3(0,1,0), forward).normalize();

  // Keyboard
  let ax = (keys['KeyD']||keys['ArrowRight']? 1:0) - (keys['KeyA']||keys['ArrowLeft']? 1:0);
  let az = (keys['KeyW']||keys['ArrowUp']?    1:0) - (keys['KeyS']||keys['ArrowDown']? 1:0);

  // Joystick (hat Vorrang wenn aktiv)
  if(joyActive){
    ax =  jx;
    az = -jy; // Joystick Y nach vorne = negativ Z
  }

  const v = new THREE.Vector3();
  if(ax || az){
    v.addScaledVector(right, ax);
    v.addScaledVector(forward, az);
    v.normalize().multiplyScalar(SPEED);
  }
  return v;
}

/* ---------- Game Loop ---------- */
addEventListener('resize', ()=>{
  renderer.setSize(innerWidth, innerHeight);
  camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix();
});

let last = performance.now();
function loop(t){
  const dt = Math.min(0.033, (t-last)/1000); last = t;

  // horizontal move
  const mv = moveVectorFromInput();
  player.position.addScaledVector(mv, dt);

  // jump/gravity
  if((keys['Space'] || wantJump) && Math.abs(player.position.y-1)<0.001){
    vy = JUMP; wantJump=false;
  }
  vy -= GRAV*dt; player.position.y += vy*dt;
  if(player.position.y < 1){ player.position.y = 1; vy = 0; }

  // camera follow
  controls.target.lerp(player.position, 0.18);
  controls.update();

  // coins rotate + collect
  coins.forEach(c=>{
    if(!c.visible) return;
    c.rotation.y += dt*2;
    if(c.position.distanceTo(player.position)<1.4){ c.visible=false; }
  });

  renderer.render(scene, camera);
  requestAnimationFrame(loop);
}
loop(last);
</script>
